{% extends "base.html" %}

{% block title %}cellSplitter · Cultures{% endblock %}

{% block content %}
  <section class="section">
    <div class="section-header with-actions">
      <div>
        <h1>Cultures</h1>
        <p>Track active cultures.</p>
      </div>
      <div class="header-actions">
        <form
          class="inline-form threshold-form"
          method="post"
          action="{{ url_for('update_stale_cutoff') }}"
        >
          <input
            type="number"
            name="stale_cutoff_days"
            value="{{ stale_cutoff_days }}"
            min="0"
            step="1"
            aria-label="Days before stale reminder"
            class="input-small"
          />
          <button class="button secondary" type="submit">Set stale days</button>
        </form>
        <form
          class="inline-form threshold-form"
          method="post"
          action="{{ url_for('update_passage_threshold') }}"
        >
          <input
            type="number"
            name="passage_warning_threshold"
            value="{{ passage_warning_threshold }}"
            min="1"
            step="1"
            aria-label="Passage reminder threshold"
            class="input-small"
          />
          <button
            type="button"
            class="button ghost info-button"
            data-passage-info
            aria-label="Learn about passage reminders"
          >
            ?
          </button>
          <button class="button secondary" type="submit">Set reminder</button>
        </form>
        <form class="inline-form" method="get" action="{{ url_for('export_cultures') }}">
          <select
            id="export-status"
            name="status"
            aria-label="Select which cultures to include in the export"
          >
            <option value="active">Active cultures</option>
            <option value="ended">Ended cultures</option>
            <option value="both">Active + ended</option>
          </select>
          <button class="button secondary" type="submit">Export CSV</button>
        </form>
        <button class="button secondary" type="button" onclick="document.getElementById('import-form').classList.toggle('hidden')">Import Database</button>
      </div>
    </div>
    <form id="import-form" class="import-form hidden" method="post" action="{{ url_for('import_database') }}" enctype="multipart/form-data">
    {% if active_cultures %}
      <div class="table-wrapper">
        <table class="table cultures-table">
          <thead>
            <tr>
              <th scope="col">Culture</th>
              <th scope="col">Started</th>
              <th scope="col">Current passage</th>
              <th scope="col">Myco status</th>
              <th scope="col" class="actions-column">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for culture in active_cultures %}
              {% set row_classes = [] %}
              {% if culture.is_stale %}
                {% set row_classes = row_classes + ['stale-row'] %}
              {% endif %}
              {% if culture.latest_passage and culture.latest_passage.passage_number > culture.passage_warning_threshold %}
                {% set row_classes = row_classes + ['passage-warning-row'] %}
              {% endif %}
              {% if culture.current_myco_status_value == 'myco_contaminated' %}
                {% set row_classes = row_classes + ['myco-alert-row'] %}
              {% endif %}
              <tr class="{{ ' '.join(row_classes) }}">
                <td>
                  <strong>{{ culture.name }}</strong>
                  <p class="meta">
                    {{ culture.cell_line.name }} ·
                    {{ culture.cell_line.display_doubling_time() }}
                  </p>
                </td>
                <td>{{ culture.start_date.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if culture.latest_passage %}
                    P{{ culture.latest_passage.passage_number }}
                    ({{ culture.latest_passage.date.strftime('%Y-%m-%d') }})
                  {% else %}
                    —
                  {% endif %}
                  {% if culture.latest_passage and culture.latest_passage.passage_number > culture.passage_warning_threshold %}
                    <p class="warning-text">
                      Exceeds reminder threshold (P{{ culture.passage_warning_threshold }}).
                    </p>
                  {% endif %}
                  {% if culture.is_stale %}
                    <p class="warning-text">
                      Last handled {{ culture.days_since_last_passage }} day{% if culture.days_since_last_passage != 1 %}s{% endif %} ago.
                    </p>
                  {% endif %}
                </td>
                <td>
                  <div class="myco-status-wrapper">
                    <span
                      class="myco-badge status-{{ culture.current_myco_status_value or 'myco_untested' }}"
                      data-myco-badge
                    >
                      {{ culture.current_myco_status_label }}
                    </span>
                    {% if not culture.myco_status_locked %}
                      <form
                        class="inline-form myco-status-form"
                        method="post"
                        action="{{ url_for('update_myco_status', culture_id=culture.id) }}"
                        data-myco-status-form
                      >
                        <input type="hidden" name="redirect" value="{{ url_for('index') }}" />
                        <select name="myco_status" class="myco-status-select" data-myco-select>
                          {% for value, label in myco_status_choices %}
                            <option value="{{ value }}" {% if culture.current_myco_status_value == value %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                        <button class="button ghost small" type="submit">Save</button>
                      </form>
                    {% endif %}
                  </div>
                </td>
                <td class="actions">
                  <a class="button" href="{{ url_for('view_culture', culture_id=culture.id) }}">
                    View journal
                  </a>
                  <form
                    class="inline-form"
                    method="post"
                    action="{{ url_for('refresh_media', culture_id=culture.id) }}"
                  >
                    <button class="button secondary" type="submit">Refresh media</button>
                  </form>
                  <form
                    class="inline-form"
                    method="post"
                    action="{{ url_for('end_culture', culture_id=culture.id) }}"
                    data-end-culture-form
                  >
                    <input type="hidden" name="ended_on" value="{{ today }}" />
                    <input type="hidden" name="end_reason" value="" />
                    <button class="button danger" type="submit">End culture</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <article class="card bulk-card">
        <header class="card-header">
          <h3>Bulk process cultures</h3>
          <p>Select multiple cultures to capture measurements, log passages, and prepare labels together.</p>
        </header>
        <div
          class="card-body"
          data-bulk-card
          data-default-vessel="{{ default_vessel_id or '' }}"
          data-today="{{ today }}"
        >
          <div class="bulk-selection" data-bulk-selection>
            <p>Select cultures to include:</p>
            <div class="bulk-selection-grid">
              {% for culture in active_cultures %}
                <label class="checkbox">
                  <input
                    type="checkbox"
                    class="bulk-culture-select"
                    value="{{ culture.id }}"
                    data-culture-id="{{ culture.id }}"
                    aria-label="Select {{ culture.name }} for bulk processing"
                  />
                  <span>{{ culture.name }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
          <div class="bulk-actions">
            <button type="button" class="button ghost" data-bulk-select-all>Select all</button>
            <button type="button" class="button secondary" data-bulk-generate-copy>
              Generate copy table
            </button>
            <button type="button" class="button secondary" data-bulk-start>Start harvest</button>
          </div>
          <div class="bulk-output" id="bulk-copy-output" hidden></div>
          <div class="bulk-workflow" data-bulk-workflow hidden>
            <div class="bulk-tabs">
              <button type="button" class="bulk-tab is-active" data-bulk-tab="harvest">
                Harvest
              </button>
              <button type="button" class="bulk-tab" data-bulk-tab="planner" disabled>
                Planner
              </button>
            </div>
            <form class="form bulk-harvest-form" data-bulk-harvest-form>
              <div class="table-wrapper">
                <table class="table bulk-harvest-table">
                  <thead>
                    <tr>
                      <th scope="col">Culture</th>
                      <th scope="col">Pre-split confluence (%)</th>
                      <th scope="col">Measured concentration (cells/mL)</th>
                      <th scope="col">Viability (%)</th>
                      <th scope="col">Slurry volume (mL)</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="form-actions">
                <button class="button primary" type="submit">Save harvest</button>
              </div>
              <p class="form-hint bulk-status" data-harvest-status></p>
            </form>
            <form class="form bulk-planner-form" data-bulk-planner-form hidden>
              <div class="table-wrapper">
                <table class="table bulk-planner-table">
                  <thead>
                    <tr>
                      <th scope="col">Culture</th>
                      <th scope="col">Seeding planner</th>
                      <th scope="col">Passage details</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="form-actions">
                <button class="button primary" type="submit">Save passages</button>
              </div>
              <p class="form-hint bulk-status" data-planner-status></p>
            </form>
            <p class="form-hint bulk-status" data-bulk-status></p>
          </div>
          <div class="bulk-output" id="bulk-label-output" hidden></div>
        </div>
      </article>
      <article class="card label-card collapsible-card" data-collapsible>
        <header class="card-header collapsible-header">
          <button
            type="button"
            class="collapse-toggle"
            data-collapse-target="myco-label-body"
            aria-expanded="false"
          >
              <div>
                <h3>Myco test labels</h3>
                <p>Quick label text for active cultures with optional date and notes.</p>
              </div>
            <span class="collapse-indicator" aria-hidden="true">+</span>
          </button>
        </header>
        <div class="card-body collapsible-body" id="myco-label-body" hidden>
          <div
            class="label-append-controls"
            id="myco-label-controls"
            data-label-append-controls
            data-today="{{ today.strftime('%Y-%m-%d') }}"
            data-append-date="true"
          >
            <button
              type="button"
              class="button ghost small"
              data-append-today
              aria-pressed="true"
            >
              Append today's date
            </button>
            <div class="append-text-group">
              <label class="sr-only" for="myco-label-append-text">Extra label text</label>
              <input
                type="text"
                id="myco-label-append-text"
                data-append-text
                placeholder="Optional extra text to append"
                autocomplete="off"
              />
            </div>
          </div>
          <div class="card-actions">
            <button
              type="button"
              class="button ghost"
              data-select-label-table="myco-label-table"
            >
              Select all
            </button>
            <button
              type="button"
              class="button secondary"
              data-copy-label-table="myco-label-table"
              data-label-controls="myco-label-controls"
            >
              Copy table
            </button>
          </div>
          <div class="table-wrapper">
            <table class="table label-table" id="myco-label-table">
              <thead>
                <tr>
                  <th scope="col" class="select-col" aria-label="Select label"></th>
                  <th scope="col">Label text</th>
                  <th scope="col">Culture</th>
                </tr>
              </thead>
              <tbody>
                {% for culture in active_cultures %}
                  {% set label_text = culture.name %}
                  <tr>
                    <td class="select-cell">
                      <input
                        type="checkbox"
                        class="label-select"
                        name="myco-select-{{ loop.index }}"
                        aria-label="Select label for {{ culture.name }}"
                      />
                    </td>
                    <td class="wrap">
                      <pre class="label-snippet">{{ label_text }}</pre>
                    </td>
                    <td class="label-extra">{{ culture.name }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </article>
    {% else %}
      <p class="empty-state">No active cultures yet. Create one below to get started.</p>
    {% endif %}
    <article class="card label-card collapsible-card" data-collapsible>
      <header class="card-header collapsible-header">
        <button
          type="button"
          class="collapse-toggle"
          data-collapse-target="label-library-body"
          aria-expanded="false"
        >
          <div>
            <h3>Label library</h3>
            <p>Save quick clipboard snippets for frequently used reagents.</p>
          </div>
          <span class="collapse-indicator" aria-hidden="true">+</span>
        </button>
      </header>
      <div class="card-body collapsible-body" id="label-library-body" hidden>
        <div
          class="label-append-controls"
          id="label-library-controls"
          data-label-append-controls
          data-today="{{ today.strftime('%Y-%m-%d') }}"
          data-append-date="false"
        >
          <button
            type="button"
            class="button ghost small"
            data-append-today
            aria-pressed="false"
          >
            Append today's date
          </button>
          <div class="append-text-group">
            <label class="sr-only" for="label-append-text">Extra label text</label>
            <input
              type="text"
              id="label-append-text"
              data-append-text
              placeholder="Optional extra text to append"
              autocomplete="off"
            />
          </div>
        </div>
        <div class="card-actions">
          <button
            type="button"
            class="button ghost"
            data-select-label-table="label-library-table"
          >
            Select all
          </button>
          <button
            type="button"
            class="button secondary"
            data-copy-label-table="label-library-table"
            data-label-controls="label-library-controls"
          >
            Copy labels
          </button>
        </div>
        <div class="table-wrapper">
          <table class="table label-table" id="label-library-table">
            <thead>
              <tr>
                <th scope="col" class="select-col" aria-label="Select label"></th>
                <th scope="col">Label text</th>
                <th scope="col" class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if label_library %}
                {% for label in label_library %}
                  <tr>
                    <td class="select-cell">
                      <input
                        type="checkbox"
                        class="label-select"
                        name="library-select-{{ loop.index }}"
                        aria-label="Select saved label {{ loop.index }}"
                      />
                    </td>
                    <td class="wrap">
                      <pre class="label-snippet">{{ label }}</pre>
                    </td>
                    <td class="actions">
                      <form
                        class="inline-form"
                        method="post"
                        action="{{ url_for('delete_label', label_index=loop.index0) }}"
                      >
                        <button class="button ghost small" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="3" class="empty-state">No saved labels yet.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <form class="inline-form add-label-form" method="post" action="{{ url_for('add_label') }}">
          <label class="sr-only" for="new-label-text">New label text</label>
          <input
            type="text"
            id="new-label-text"
            name="label_text"
            placeholder="Enter label text (ASCII only)"
            required
          />
          <button class="button secondary" type="submit">Add label</button>
        </form>
      </div>
    </article>
  </section>

  <section class="section">
    <div class="section-header">
      <h2>Start a new culture</h2>
      <p>Create a culture and log its initial passage (defaults to P1).</p>
    </div>
    <form
      class="form"
      method="post"
      action="{{ url_for('create_culture') }}"
      data-create-culture-form
    >
      <div class="field-grid">
        <label>
          <span>Culture name</span>
          <input type="text" name="name" placeholder="e.g. HEK293FT batch A" required />
        </label>
        <label>
          <span>Cell line</span>
          <select name="cell_line_id" required>
            <option value="">Select a cell line…</option>
            {% for cell_line in cell_lines %}
              <option value="{{ cell_line.id }}">{{ cell_line.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Start date</span>
          <input type="date" name="start_date" value="{{ today }}" />
        </label>
        <label>
          <span>Culture notes (optional)</span>
          <input type="text" name="culture_notes" placeholder="e.g. thawed from vial 3" />
        </label>
      </div>
      <fieldset class="fieldset">
        <legend>Initial passage</legend>
        <div class="field-grid">
          <label class="wide">
            <span>Copy initial details (optional)</span>
            <select
              name="initial_template"
              data-prefill-select
              {% if not culture_prefill_groups %}disabled{% endif %}
            >
              <option value="">
                {% if culture_prefill_groups %}
                  Select a culture…
                {% else %}
                  No saved cultures available
                {% endif %}
              </option>
              {% for group in culture_prefill_groups %}
                <optgroup label="{{ group.label }}">
                  {% for entry in group.entries %}
                    <option value="{{ entry.id }}">
                      {{ entry.name }}
                      {% if entry.cell_line %}
                        · {{ entry.cell_line }}
                      {% endif %}
                      {% if entry.latest_passage_number %}
                        · P{{ entry.latest_passage_number }}
                      {% endif %}
                    </option>
                  {% endfor %}
                </optgroup>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>Passage number</span>
            <input
              type="number"
              name="initial_passage_number"
              value="1"
              min="1"
              step="1"
            />
          </label>
          <label>
            <span>Media</span>
            <input type="text" name="initial_media" placeholder="e.g. DMEM + 10% FBS" />
          </label>
          <label>
            <span>Vessel (optional)</span>
            <select name="initial_vessel_id">
              <option value="">Select a vessel…</option>
              {% for vessel in vessels %}
                <option value="{{ vessel.id }}">
                  {{ vessel.name }} ({{ '%g' % vessel.area_cm2 }} cm²)
                </option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>Cell concentration (cells/mL)</span>
            <input type="text" name="initial_cell_concentration" placeholder="e.g. 1.5e6" />
          </label>
          <label>
            <span>Seeded cells (total)</span>
            <input type="text" name="initial_seeded_cells" placeholder="e.g. 2e6" />
          </label>
          <label>
            <span>Viability (%)</span>
            <input
              type="number"
              name="initial_viability_percent"
              min="0"
              max="100"
              step="1"
            />
          </label>
          <label>
            <span>Doubling time (hours)</span>
            <input type="text" name="initial_doubling_time" placeholder="e.g. 22" />
          </label>
          <label class="wide">
            <span>Notes</span>
            <textarea name="initial_notes" rows="2" placeholder="Optional observations"></textarea>
          </label>
        </div>
        <p class="form-hint">Provide either an initial concentration or the total cells seeded.</p>
      </fieldset>
      <button class="button primary" type="submit">Create culture</button>
    </form>
  </section>

  <section class="section">
    <div class="section-header">
      <h2>Cell line doubling-time library</h2>
      <p>Add new lines or review existing doubling-time references.</p>
    </div>
    <div class="grid">
      <article class="card">
        <header class="card-header">
          <h3>Add a cell line</h3>
        </header>
        <form class="card-body form" method="post" action="{{ url_for('create_cell_line') }}">
          <label>
            <span>Cell line name</span>
            <input type="text" name="name" required placeholder="e.g. HCT116" />
          </label>
          <div class="field-grid">
            <label>
              <span>Doubling time (min, h)</span>
              <input type="text" name="doubling_time_min_hours" placeholder="e.g. 22" />
            </label>
            <label>
              <span>Doubling time (max, h)</span>
              <input type="text" name="doubling_time_max_hours" placeholder="e.g. 28" />
            </label>
          </div>
          <label>
            <span>Reference URL</span>
            <input type="url" name="reference_url" placeholder="https://" />
          </label>
          <label>
            <span>Notes</span>
            <textarea name="notes" rows="2" placeholder="Source or assay details"></textarea>
          </label>
          <button class="button primary" type="submit">Add cell line</button>
        </form>
      </article>
      <article class="card">
        <header class="card-header">
          <h3>Catalogued cell lines</h3>
        </header>
        <div class="card-body">
          {% if cell_lines %}
            <ul class="cell-line-list">
              {% for cell_line in cell_lines %}
                <li>
                  <div>
                    <strong>{{ cell_line.name }}</strong>
                    <span class="meta">{{ cell_line.display_doubling_time() }}</span>
                  </div>
                  {% if cell_line.reference_url %}
                    <a href="{{ cell_line.reference_url }}" target="_blank" rel="noopener">Reference</a>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No cell lines recorded yet.</p>
          {% endif %}
        </div>
      </article>
    </div>
  </section>

  {% if ended_cultures %}
    <section class="section">
      <div class="section-header">
        <h2>Cultures ended</h2>
        <p>Archived cultures with preserved passage history.</p>
      </div>
      <div class="grid">
        {% for culture in ended_cultures %}
          <article class="card muted">
            <header class="card-header">
              <h3>{{ culture.name }}</h3>
              <p>
                {{ culture.cell_line.name }} · Ended
                {{ culture.ended_on.strftime('%Y-%m-%d') if culture.ended_on else '—' }}
              </p>
            </header>
            <div class="card-body">
              <dl>
                <div>
                  <dt>Started</dt>
                  <dd>{{ culture.start_date.strftime('%Y-%m-%d') }}</dd>
                </div>
                <div>
                  <dt>Final passage</dt>
                  <dd>
                    {% if culture.latest_passage %}
                      P{{ culture.latest_passage.passage_number }}
                      ({{ culture.latest_passage.date.strftime('%Y-%m-%d') }})
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>
                <div>
                  <dt>Myco status</dt>
                  <dd>{{ culture.current_myco_status_value | display_myco_status }}</dd>
                </div>
                {% if culture.end_reason %}
                  <div>
                    <dt>Reason</dt>
                    <dd>{{ culture.end_reason }}</dd>
                  </div>
                {% endif %}
              </dl>
            </div>
            <footer class="card-footer">
              <a class="button" href="{{ url_for('view_culture', culture_id=culture.id) }}">
                View journal
              </a>
              <form
                class="inline-form"
                method="post"
                action="{{ url_for('delete_culture', culture_id=culture.id) }}"
                onsubmit="return confirm('Permanently delete {{ culture.name }}? This cannot be undone.');"
              >
                <button class="button danger" type="submit">Delete</button>
              </form>
            </footer>
          </article>
        {% endfor %}
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="application/json" id="create-culture-prefill-data">
    {{ culture_prefill_json | safe }}
  </script>
  {% if active_cultures %}
    <script type="application/json" id="bulk-culture-data">
      {{ bulk_cultures_json | safe }}
    </script>
    <script type="application/json" id="bulk-vessel-data">
      {{ vessel_payload_json | safe }}
    </script>
  {% endif %}
{% endblock %}
